# ================================================================
# Azure Pipelines - Terraform Phase 1 (Manual Trigger)
# ================================================================

trigger: none  # ğŸ”¹ Cháº¡y thá»§ cÃ´ng

pool:
  name: 'NhanNgoPC'
  demands:
  - agent.name -equals ubuntu-wsl-pool

variables:
  tfBackendRG: 'terraform-backend-rg'
  tfStorageAccount: 'tfbackendstorage125'
  tfContainer: 'tfstate'
  projectName: 'agentic_chatbot'
  location: 'southeastasia'
  acrName: 'acrngothanhnhan125'
  
stages:
- stage: TerraformPhase1
  displayName: "Terraform Phase 1: Provision Infra"
  jobs:
  - job: TerraformPhase1Apply
    displayName: "Terraform Apply Phase 1"
    steps:
    - task: Bash@3
      displayName: "Run Terraform Phase 1 using Service Principal Auth"
      env:
        ARM_CLIENT_ID: $(ARM_CLIENT_ID)
        ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
        ARM_TENANT_ID: $(ARM_TENANT_ID)
        ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
        tfBackendRG: $(tfBackendRG)
        tfStorageAccount: $(tfStorageAccount)
        tfContainer: $(tfContainer)
        projectName: $(projectName)
        acrName: $(acrName)
      inputs:
        targetType: 'inline'
        script: |
          set -e
          echo "ğŸ” Checking Terraform installation..."
          if ! command -v terraform &> /dev/null; then
            sudo apt-get update -y && sudo apt-get install -y unzip curl
            curl -fsSL https://releases.hashicorp.com/terraform/1.5.0/terraform_1.5.0_linux_amd64.zip -o tf.zip
            unzip tf.zip && sudo mv terraform /usr/local/bin/ && rm tf.zip
          fi

          echo "ğŸ§© Logging into Azure..."
          az logout || true
          az login --service-principal \
            -u "$ARM_CLIENT_ID" \
            -p "$ARM_CLIENT_SECRET" \
            --tenant "$ARM_TENANT_ID"

          az account set --subscription "$ARM_SUBSCRIPTION_ID"

          echo "ğŸ”‘ Fetching Storage Account Access Key..."
          export ARM_ACCESS_KEY=$(az storage account keys list \
            --resource-group "$tfBackendRG" \
            --account-name "$tfStorageAccount" \
            --query [0].value -o tsv)

          echo "ğŸš€ Running Terraform..."
          cd terraform/phase1

          echo "ğŸ§¹ Cleaning Terraform cache..."
          rm -rf .terraform .terraform.lock.hcl || true

          echo "ğŸ§© Initializing Terraform backend..."
          terraform init -reconfigure \
            -backend-config="resource_group_name=${tfBackendRG}" \
            -backend-config="storage_account_name=${tfStorageAccount}" \
            -backend-config="container_name=${tfContainer}" \
            -backend-config="key=${projectName}-phase1.tfstate"

          echo "âš™ï¸ Checking and importing existing resources if needed..."

          # --- ğŸ§© Import Resource Group náº¿u Ä‘Ã£ tá»“n táº¡i ---
          if az group show --name "${projectName}" >/dev/null 2>&1; then
            echo "âš™ï¸ Resource Group '${projectName}' exists â†’ Importing..."
            terraform import azurerm_resource_group.rg "/subscriptions/${ARM_SUBSCRIPTION_ID}/resourceGroups/${projectName}" || true
          else
            echo "ğŸ†• Resource Group '${projectName}' does not exist â†’ Terraform will create it."
          fi

          # --- ğŸ§© Import ACR náº¿u Ä‘Ã£ tá»“n táº¡i ---
          if az acr show --name "${acrName}" --resource-group "${projectName}" >/dev/null 2>&1; then
            echo "âš™ï¸ ACR '${acrName}' exists â†’ Importing..."
            terraform import azurerm_container_registry.acr "/subscriptions/${ARM_SUBSCRIPTION_ID}/resourceGroups/${projectName}/providers/Microsoft.ContainerRegistry/registries/${acrName}" || true
          else
            echo "ğŸ†• ACR '${acrName}' does not exist â†’ Terraform will create it."
          fi

          # --- ğŸ§© Import Container App Environment náº¿u Ä‘Ã£ tá»“n táº¡i ---
          if az containerapp env show --name "aca-chatbot-env" --resource-group "${projectName}" >/dev/null 2>&1; then
            echo "âš™ï¸ Container App Environment 'aca-chatbot-env' exists â†’ Importing..."
            terraform import azurerm_container_app_environment.env "/subscriptions/${ARM_SUBSCRIPTION_ID}/resourceGroups/${projectName}/providers/Microsoft.App/managedEnvironments/aca-chatbot-env" || true
          else
            echo "ğŸ†• Container App Environment 'aca-chatbot-env' does not exist â†’ Terraform will create it."
          fi

          echo "ğŸ©µ Fixing provider file permissions..."
          find .terraform/providers -type f -name "terraform-provider-*" -exec chmod +x {} \; || true

          echo "ğŸ§± Running Terraform Apply..."
          terraform apply -auto-approve

          echo "âœ… Terraform Phase 1 completed successfully!"
